<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PROPLINE — Parlay Slip Maker</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:#101a33;
      --card2:#0f1730;
      --text:#e9eefc;
      --muted:#a9b6df;
      --line:#233157;
      --good:#25d366;
      --warn:#ffcc00;
      --bad:#ff4d4d;
      --accent:#7c5cff;
      --accent2:#00d4ff;
      --shadow: 0 12px 34px rgba(0,0,0,.35);
      --radius: 16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 700px at 20% 10%, rgba(124,92,255,.25), transparent 55%),
                  radial-gradient(900px 550px at 80% 20%, rgba(0,212,255,.18), transparent 55%),
                  linear-gradient(180deg, #070b16, var(--bg) 40%, #070b16);
      color:var(--text);
      min-height:100vh;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:22px}
    header{
      display:flex;align-items:center;justify-content:space-between;gap:16px;
      padding:18px 18px;border:1px solid var(--line);border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(16,26,51,.88), rgba(16,26,51,.65));
      box-shadow:var(--shadow);
      position:sticky; top:10px; backdrop-filter: blur(10px);
      z-index:5;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:44px;height:44px;border-radius:12px;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      box-shadow:0 10px 26px rgba(124,92,255,.25);
      position:relative;overflow:hidden;
    }
    .logo:after{
      content:"";position:absolute;inset:-20px;
      background:conic-gradient(from 180deg, rgba(255,255,255,.35), transparent 35%, rgba(255,255,255,.18));
      animation:spin 6s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .title h1{margin:0;font-size:16px;letter-spacing:.6px}
    .title p{margin:2px 0 0;color:var(--muted);font-size:12px}
    .pill{
      font-family:var(--mono);
      font-size:12px;
      color:rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.12);
      padding:8px 10px;border-radius:999px;
      background:rgba(0,0,0,.18);
      display:flex;gap:10px;align-items:center;white-space:nowrap;
    }
    .pill b{color:#fff}
    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:18px;
      margin-top:18px;
    }
    @media (max-width: 980px){
      header{position:static}
      .grid{grid-template-columns:1fr}
    }
    .card{
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(16,26,51,.75), rgba(15,23,48,.75));
      box-shadow:var(--shadow);
      padding:16px;
    }
    .card h2{margin:0 0 10px;font-size:14px;letter-spacing:.5px}
    .sub{color:var(--muted);font-size:12px;margin:0 0 12px;line-height:1.4}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input, select, textarea{
      width:100%;
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:90px;resize:vertical;font-family:var(--mono);font-size:12px}
    input:focus, select:focus, textarea:focus{border-color:rgba(0,212,255,.45);box-shadow:0 0 0 3px rgba(0,212,255,.12)}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    button{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      font-weight:600;
      transition:.15s transform, .15s opacity, .15s border-color;
    }
    button:hover{transform:translateY(-1px);border-color:rgba(0,212,255,.35)}
    button:active{transform:translateY(0px);opacity:.9}
    .primary{
      background:linear-gradient(135deg, rgba(124,92,255,.95), rgba(0,212,255,.75));
      border-color:rgba(255,255,255,.18);
      color:#071022;
    }
    .danger{
      background:linear-gradient(135deg, rgba(255,77,77,.95), rgba(255,204,0,.35));
      color:#1a0a0a;
      border-color:rgba(255,255,255,.14);
    }
    .ghost{background:transparent}
    .mini{font-size:12px;padding:8px 10px;border-radius:10px;font-weight:700}
    .table{
      width:100%;
      border-collapse:separate;border-spacing:0;
      overflow:hidden;border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.16);
    }
    .table th, .table td{
      text-align:left;padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      font-size:12px;vertical-align:top;
    }
    .table th{color:var(--muted);font-weight:700}
    .table tr:last-child td{border-bottom:none}
    .tag{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 8px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.12);
      font-size:11px;color:var(--muted);
      white-space:nowrap;
      margin-right:6px;
    }
    .kpi{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px}
    .kpi .box{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.14);
      border-radius:14px;padding:10px;
    }
    .kpi .box .t{color:var(--muted);font-size:11px;margin-bottom:4px}
    .kpi .box .v{font-family:var(--mono);font-size:14px}
    .good{color:var(--good)}
    .warn{color:var(--warn)}
    .bad{color:var(--bad)}
    footer{opacity:.9;margin-top:18px;color:var(--muted);font-size:12px;line-height:1.45}
    .overlay{
      position:fixed;inset:0;
      background:radial-gradient(900px 600px at 30% 20%, rgba(124,92,255,.22), transparent 55%),
                 radial-gradient(900px 600px at 70% 35%, rgba(0,212,255,.18), transparent 55%),
                 rgba(0,0,0,.65);
      display:flex;align-items:center;justify-content:center;
      padding:18px; z-index:50;
    }
    .login{
      width:min(520px, 100%);
      border:1px solid rgba(255,255,255,.12);
      background:linear-gradient(180deg, rgba(16,26,51,.92), rgba(15,23,48,.82));
      border-radius:20px;
      box-shadow:0 20px 60px rgba(0,0,0,.55);
      padding:18px;
    }
    .login h2{margin:0 0 6px;font-size:16px}
    .login p{margin:0 0 12px;color:var(--muted);font-size:12px;line-height:1.5}
    .hint{font-family:var(--mono);font-size:12px;color:#dbe6ff;opacity:.9}
    .shake{animation:shake .25s ease-in-out 0s 2}
    @keyframes shake{
      0%{transform:translateX(0)}
      25%{transform:translateX(-6px)}
      50%{transform:translateX(6px)}
      75%{transform:translateX(-4px)}
      100%{transform:translateX(0)}
    }
    .muted{color:var(--muted)}
    .rightTools{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .notice{
      margin-top:10px;
      border:1px dashed rgba(255,255,255,.18);
      background:rgba(0,0,0,.14);
      border-radius:14px;
      padding:10px;
      font-size:12px;
      color:var(--muted);
      line-height:1.45;
    }
    .small{font-size:11px}
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:rgba(0,0,0,.6);
      border:1px solid rgba(255,255,255,.14);
      padding:10px 12px;border-radius:999px;
      font-size:12px;color:var(--text);
      opacity:0;pointer-events:none;
      transition:opacity .2s, transform .2s;
      z-index:80;
      font-family:var(--mono);
    }
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-4px)}
    details{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.14);
      border-radius:14px;
      padding:10px;
      margin-top:10px;
    }
    summary{cursor:pointer;color:var(--text);font-weight:700;font-size:12px}
  </style>
</head>
<body>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- LOGIN -->
  <div id="overlay" class="overlay" aria-hidden="false">
    <div id="loginCard" class="login">
      <div class="brand" style="margin-bottom:10px">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">
          <h1>PROPLINE</h1>
          <p>Backed by data. Simulated for truth. Created by NotSoCj.</p>
        </div>
      </div>

      <h2>Enter Access Code</h2>
      <p>This is a <b>parlay slip maker</b> (no bets placed here). For entertainment & analysis only.</p>

      <div class="row">
        <div style="flex:1.2">
          <label for="codeInput">5-digit code</label>
          <input id="codeInput" inputmode="numeric" maxlength="5" placeholder="e.g. 64786" />
        </div>
        <div style="flex:.8">
          <label>&nbsp;</label>
          <button id="unlockBtn" class="primary" style="width:100%">Unlock</button>
        </div>
      </div>

      <div class="notice">
        <div class="hint">Default code: <b id="defaultCodeHint">64786</b></div>
        <div class="small muted" style="margin-top:6px">You can change the code in Settings after you log in.</div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">
          <h1>PROPLINE — Parlay Slip Maker</h1>
          <p>Build slips fast • Copy/paste into your book/DFS app • No live scores</p>
        </div>
      </div>

      <div class="rightTools">
        <button id="lockBtn" class="mini ghost" title="Lock the app (requires code again)">Lock</button>
        <span class="pill"><b id="legCount">0</b> legs</span>
        <span class="pill">Parlay Odds: <b id="parlayOdds">—</b></span>
        <span class="pill">Implied: <b id="parlayImplied">—</b></span>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT -->
      <section class="card">
        <h2>Build Your Slip</h2>
        <p class="sub">Add legs + American odds. Optional “Your hit %” shows implied probability + edge.</p>

        <div class="row">
          <div>
            <label for="sport">Sport</label>
            <select id="sport">
              <option value="NBA">NBA</option>
              <option value="NFL">NFL</option>
              <option value="NHL">NHL</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div>
            <label for="market">Market</label>
            <select id="market">
              <option value="Player Points">Player Points</option>
              <option value="Player Rebounds">Player Rebounds</option>
              <option value="Player Assists">Player Assists</option>
              <option value="Player 3PT Made">Player 3PT Made</option>
              <option value="Player Shots (NHL)">Player Shots (NHL)</option>
              <option value="Player Goals (NHL)">Player Goals (NHL)</option>
              <option value="Player Saves (NHL)">Player Saves (NHL)</option>
              <option value="Player Yards (NFL)">Player Yards (NFL)</option>
              <option value="Player Receptions (NFL)">Player Receptions (NFL)</option>
              <option value="Player TD (NFL)">Player TD (NFL)</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div style="flex:1.2">
            <label for="desc">Leg description</label>
            <input id="desc" placeholder="Example: J. Tatum — Over 27.5 PTS vs LAL" />
          </div>
          <div style="flex:.7">
            <label for="american">American odds</label>
            <input id="american" inputmode="numeric" placeholder="-110 or +125" />
          </div>
          <div style="flex:.7">
            <label for="proj">Your hit % (optional)</label>
            <input id="proj" inputmode="decimal" placeholder="e.g. 58" />
          </div>
        </div>

        <div class="btns">
          <button id="addBtn" class="primary">Add Leg</button>
          <button id="addTemplateBtn" class="ghost">Quick Templates</button>
          <button id="clearBtn" class="danger">Clear Slip</button>
        </div>

        <details>
          <summary>Import Legs (paste multiple)</summary>
          <p class="sub" style="margin-top:8px">
            Format per line: <span style="font-family:var(--mono)">Description | Odds | (optional) Your%</span><br/>
            Example: <span style="font-family:var(--mono)">LeBron Over 25.5 PTS | -115 | 56</span>
          </p>
          <textarea id="importBox" placeholder="Paste lines here..."></textarea>
          <div class="btns">
            <button id="importBtn" class="primary">Import</button>
            <button id="clearImportBtn" class="ghost">Clear Import</button>
          </div>
        </details>

        <div style="margin-top:14px;overflow:auto">
          <table class="table" aria-label="Slip legs table">
            <thead>
              <tr>
                <th style="width:22%">Sport / Market</th>
                <th>Description</th>
                <th style="width:12%">Odds</th>
                <th style="width:14%">Implied</th>
                <th style="width:14%">Your %</th>
                <th style="width:12%">Edge</th>
                <th style="width:10%"></th>
              </tr>
            </thead>
            <tbody id="legsBody">
              <tr>
                <td colspan="7" class="muted">No legs yet. Add your first pick above.</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="kpi">
          <div class="box">
            <div class="t">Combined Decimal Odds</div>
            <div class="v" id="parlayDecimal">—</div>
          </div>
          <div class="box">
            <div class="t">Your Slip Hit % (only if you filled all “Your %”)</div>
            <div class="v" id="userSlipProb">—</div>
          </div>
        </div>

        <div class="notice">
          <b>Note:</b> This is a slip builder UI. It does <b>not</b> scrape odds/lineups.
        </div>
      </section>

      <!-- RIGHT -->
      <aside class="card">
        <h2>Slip Output</h2>
        <p class="sub">Copy clean text. Save/load locally. Export JSON for future upgrades.</p>

        <div class="row">
          <div>
            <label for="titleInput">Slip title</label>
            <input id="titleInput" placeholder="Example: NBA 3-Leg (Safe)" />
          </div>
          <div>
            <label for="oddsFormat">Display odds</label>
            <select id="oddsFormat">
              <option value="american">American</option>
              <option value="decimal">Decimal</option>
            </select>
          </div>
        </div>

        <div style="margin-top:10px">
          <label for="output">Copy/paste slip</label>
          <textarea id="output" spellcheck="false" readonly></textarea>
        </div>

        <div class="btns">
          <button id="copyBtn" class="primary">Copy Slip</button>
          <button id="saveBtn">Save</button>
          <button id="loadBtn">Load</button>
          <button id="exportBtn">Export JSON</button>
        </div>

        <hr style="border:none;border-top:1px solid rgba(255,255,255,.10);margin:14px 0">

        <h2>Settings</h2>
        <div class="row">
          <div>
            <label for="codeSetting">Change access code (5 digits)</label>
            <input id="codeSetting" inputmode="numeric" maxlength="5" placeholder="64786" />
          </div>
          <div style="flex:.8">
            <label>&nbsp;</label>
            <button id="setCodeBtn" style="width:100%">Update Code</button>
          </div>
        </div>

        <div class="notice">
          <b>Disclaimer:</b> 18+ • entertainment/education only • not financial advice • no bets placed here.
        </div>

        <footer>
          Single-file GitHub Pages ready • PROPLINE.
        </footer>
      </aside>
    </div>
  </div>

  <script>
    // =========================
    // PROPLINE — Single-file app
    // =========================

    // ---- toast
    const toastEl = document.getElementById("toast");
    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      clearTimeout(toastEl._t);
      toastEl._t = setTimeout(()=>toastEl.classList.remove("show"), 1200);
    }

    // ---- helpers
    function toNumber(x){
      if(x === null || x === undefined) return NaN;
      const s = String(x).trim().replace(/,/g,'');
      if(!s) return NaN;
      return Number(s);
    }

    function americanToDecimal(amer){
      const a = toNumber(amer);
      if(!Number.isFinite(a) || a === 0) return NaN;
      if(a > 0) return 1 + (a/100);
      return 1 + (100/Math.abs(a));
    }

    function decimalToAmerican(dec){
      const d = toNumber(dec);
      if(!Number.isFinite(d) || d <= 1) return NaN;
      if(d >= 2) return Math.round((d - 1) * 100);
      return -Math.round(100 / (d - 1));
    }

    function impliedProbFromDecimal(dec){
      const d = toNumber(dec);
      if(!Number.isFinite(d) || d <= 1) return NaN;
      return 1 / d;
    }

    function fmtPct(p){
      if(!Number.isFinite(p)) return "—";
      return (p*100).toFixed(1) + "%";
    }

    function fmtAmer(a){
      if(!Number.isFinite(a)) return "—";
      return (a > 0 ? "+" : "") + String(a);
    }

    function fmtDec(d){
      if(!Number.isFinite(d)) return "—";
      return d.toFixed(3);
    }

    function edgeText(userPct, impliedPct){
      if(!Number.isFinite(userPct) || !Number.isFinite(impliedPct)) return {txt:"—", cls:"muted"};
      const edge = (userPct - impliedPct);
      const txt = (edge >= 0 ? "+" : "") + (edge*100).toFixed(1) + "%";
      if(edge >= 0.05) return {txt, cls:"good"};
      if(edge >= 0.0) return {txt, cls:"warn"};
      return {txt, cls:"bad"};
    }

    // ---- state
    let legs = [];

    // ---- storage keys
    const LS = {
      slip: "propline_slip_v1",
      code: "propline_code_v1",
      authed: "propline_authed_v1"
    };

    // ---- elements
    const overlay = document.getElementById("overlay");
    const loginCard = document.getElementById("loginCard");
    const codeInput = document.getElementById("codeInput");
    const unlockBtn = document.getElementById("unlockBtn");
    const defaultCodeHint = document.getElementById("defaultCodeHint");

    const sportEl = document.getElementById("sport");
    const marketEl = document.getElementById("market");
    const descEl = document.getElementById("desc");
    const americanEl = document.getElementById("american");
    const projEl = document.getElementById("proj");

    const addBtn = document.getElementById("addBtn");
    const addTemplateBtn = document.getElementById("addTemplateBtn");
    const clearBtn = document.getElementById("clearBtn");

    const legsBody = document.getElementById("legsBody");

    const legCount = document.getElementById("legCount");
    const parlayOdds = document.getElementById("parlayOdds");
    const parlayImplied = document.getElementById("parlayImplied");
    const parlayDecimalEl = document.getElementById("parlayDecimal");
    const userSlipProbEl = document.getElementById("userSlipProb");

    const titleInput = document.getElementById("titleInput");
    const oddsFormat = document.getElementById("oddsFormat");
    const output = document.getElementById("output");
    const copyBtn = document.getElementById("copyBtn");
    const saveBtn = document.getElementById("saveBtn");
    const loadBtn = document.getElementById("loadBtn");
    const exportBtn = document.getElementById("exportBtn");

    const codeSetting = document.getElementById("codeSetting");
    const setCodeBtn = document.getElementById("setCodeBtn");

    const lockBtn = document.getElementById("lockBtn");

    const importBox = document.getElementById("importBox");
    const importBtn = document.getElementById("importBtn");
    const clearImportBtn = document.getElementById("clearImportBtn");

    // ---- access code
    function getCode(){
      const saved = localStorage.getItem(LS.code);
      return (saved && saved.length === 5) ? saved : "64786";
    }
    function setCode(newCode){
      localStorage.setItem(LS.code, newCode);
    }
    function isAuthed(){
      return localStorage.getItem(LS.authed) === "1";
    }
    function setAuthed(v){
      localStorage.setItem(LS.authed, v ? "1" : "0");
    }
    function lock(){
      setAuthed(false);
      overlay.style.display = "flex";
      overlay.setAttribute("aria-hidden","false");
      codeInput.value = "";
      setTimeout(()=>codeInput.focus(), 0);
    }
    function unlock(){
      overlay.style.display = "none";
      overlay.setAttribute("aria-hidden","true");
      setAuthed(true);
    }
    function tryUnlock(){
      const expected = getCode();
      const got = String(codeInput.value || "").trim();
      if(got === expected){
        unlock();
        codeSetting.value = expected;
        toast("Unlocked ✓");
        return;
      }
      loginCard.classList.add("shake");
      setTimeout(()=>loginCard.classList.remove("shake"), 350);
      codeInput.value = "";
      codeInput.focus();
      toast("Wrong code");
    }

    // ---- calculations
    function calcParlay(){
      let dec = 1;
      for(const l of legs){
        const d = americanToDecimal(l.american);
        if(!Number.isFinite(d)) return { dec: NaN, amer: NaN, implied: NaN };
        dec *= d;
      }
      const implied = impliedProbFromDecimal(dec);
      const amer = decimalToAmerican(dec);
      return { dec, amer, implied };
    }

    function calcUserSlipProb(){
      if(legs.length === 0) return NaN;
      for(const l of legs){
        if(!Number.isFinite(l.userProb)) return NaN;
      }
      let p = 1;
      for(const l of legs) p *= l.userProb;
      return p;
    }

    function buildOutputText(){
      const title = (titleInput.value || "PROPLINE Slip").trim();
      const fmt = oddsFormat.value;

      const lines = [];
      lines.push(title);
      lines.push("—".repeat(Math.min(28, title.length)));

      if(legs.length === 0){
        lines.push("(No legs yet)");
        output.value = lines.join("\n");
        return;
      }

      legs.forEach((l, idx)=>{
        const d = americanToDecimal(l.american);
        const imp = impliedProbFromDecimal(d);
        const oddsStr = (fmt === "decimal") ? `@ ${fmtDec(d)}` : `(${fmtAmer(toNumber(l.american))})`;
        const userStr = Number.isFinite(l.userProb) ? ` • You: ${(l.userProb*100).toFixed(1)}%` : "";
        const impStr = Number.isFinite(imp) ? ` • Implied: ${(imp*100).toFixed(1)}%` : "";
        lines.push(`${idx+1}) [${l.sport}] ${l.market} — ${l.desc} ${oddsStr}${impStr}${userStr}`);
      });

      const p = calcParlay();
      const userP = calcUserSlipProb();

      lines.push("");
      lines.push("Totals");
      lines.push("------");
      if(fmt === "decimal") lines.push(`Parlay Decimal: ${fmtDec(p.dec)}`);
      else lines.push(`Parlay American: ${fmtAmer(p.amer)}`);
      lines.push(`Parlay Implied: ${fmtPct(p.implied)}`);
      if(Number.isFinite(userP)) lines.push(`Your Slip Hit %: ${fmtPct(userP)}`);

      lines.push("");
      lines.push("Disclaimer: 18+ • entertainment/education only • not financial advice • no bets placed here.");
      output.value = lines.join("\n");
    }

    function render(){
      if(legs.length === 0){
        legsBody.innerHTML = `<tr><td colspan="7" class="muted">No legs yet. Add your first pick above.</td></tr>`;
      } else {
        legsBody.innerHTML = "";
        legs.forEach((l, idx)=>{
          const d = americanToDecimal(l.american);
          const imp = impliedProbFromDecimal(d);
          const edge = edgeText(l.userProb, imp);

          const tr = document.createElement("tr");

          const c1 = document.createElement("td");
          c1.innerHTML = `<span class="tag">${l.sport}</span><span class="tag">${l.market}</span>`;

          const c2 = document.createElement("td");
          c2.textContent = l.desc;

          const c3 = document.createElement("td");
          c3.style.fontFamily = "var(--mono)";
          c3.textContent = fmtAmer(toNumber(l.american));

          const c4 = document.createElement("td");
          c4.style.fontFamily = "var(--mono)";
          c4.textContent = fmtPct(imp);

          const c5 = document.createElement("td");
          c5.style.fontFamily = "var(--mono)";
          c5.textContent = Number.isFinite(l.userProb) ? ((l.userProb*100).toFixed(1) + "%") : "—";

          const c6 = document.createElement("td");
          c6.style.fontFamily = "var(--mono)";
          c6.innerHTML = `<span class="${edge.cls}">${edge.txt}</span>`;

          const c7 = document.createElement("td");
          const del = document.createElement("button");
          del.className = "mini danger";
          del.textContent = "Del";
          del.onclick = ()=>{ legs.splice(idx,1); render(); };
          c7.appendChild(del);

          tr.append(c1,c2,c3,c4,c5,c6,c7);
          legsBody.appendChild(tr);
        });
      }

      legCount.textContent = legs.length;

      const p = calcParlay();
      const fmt = oddsFormat.value;

      parlayOdds.textContent = (legs.length === 0) ? "—" : (fmt === "decimal" ? fmtDec(p.dec) : fmtAmer(p.amer));
      parlayImplied.textContent = (legs.length === 0) ? "—" : fmtPct(p.implied);
      parlayDecimalEl.textContent = (legs.length === 0) ? "—" : fmtDec(p.dec);

      const userP = calcUserSlipProb();
      userSlipProbEl.textContent = Number.isFinite(userP) ? fmtPct(userP) : "—";

      buildOutputText();
    }

    // ---- add leg
    function addLeg(){
      const sport = sportEl.value;
      const market = marketEl.value;
      const desc = (descEl.value || "").trim();
      const amer = toNumber(americanEl.value);
      const userPct = toNumber(projEl.value);

      if(!desc){ toast("Add a description"); descEl.focus(); return; }
      if(!Number.isFinite(amer) || amer === 0){ toast("Odds must be like -110 or +125"); americanEl.focus(); return; }
      const dec = americanToDecimal(amer);
      if(!Number.isFinite(dec)){ toast("Invalid odds"); americanEl.focus(); return; }

      let userProb = NaN;
      if(Number.isFinite(userPct)){
        userProb = Math.max(0.001, Math.min(0.999, userPct/100));
      }

      legs.unshift({ sport, market, desc, american: amer, userProb });

      descEl.value = "";
      americanEl.value = "";
      projEl.value = "";
      descEl.focus();
      render();
      toast("Leg added ✓");
    }

    function clearSlip(){
      legs = [];
      render();
      toast("Cleared");
    }

    // ---- templates
    function addTemplates(){
      const s = sportEl.value;
      const now = new Date();
      const stamp = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;

      const packs = {
        NBA: [
          {market:"Player Points", desc:`Example: Star scorer — Over 24.5 PTS (${stamp})`, american:-115},
          {market:"Player Rebounds", desc:`Example: Big man — Over 9.5 REB (${stamp})`, american:-110},
          {market:"Player 3PT Made", desc:`Example: Shooter — Over 2.5 3PM (${stamp})`, american:+105},
        ],
        NFL: [
          {market:"Player Yards (NFL)", desc:`Example: WR — Over 62.5 REC YDS (${stamp})`, american:-110},
          {market:"Player Receptions (NFL)", desc:`Example: TE — Over 4.5 REC (${stamp})`, american:+100},
          {market:"Player TD (NFL)", desc:`Example: RB — Anytime TD (${stamp})`, american:+125},
        ],
        NHL: [
          {market:"Player Shots (NHL)", desc:`Example: Winger — Over 2.5 SOG (${stamp})`, american:-120},
          {market:"Player Goals (NHL)", desc:`Example: Sniper — Anytime Goal (${stamp})`, american:+145},
          {market:"Player Saves (NHL)", desc:`Example: Goalie — Over 27.5 Saves (${stamp})`, american:-105},
        ],
        Other: [
          {market:"Other", desc:`Example: Prop — Over X (${stamp})`, american:-110},
          {market:"Other", desc:`Example: Prop — Under Y (${stamp})`, american:-110},
        ]
      };

      const list = packs[s] || packs.Other;
      [...list].reverse().forEach(item=>{
        legs.unshift({ sport:s, market:item.market, desc:item.desc, american:item.american, userProb:NaN });
      });
      render();
      toast("Templates added ✓");
    }

    // ---- import
    function importLegs(){
      const text = (importBox.value || "").trim();
      if(!text){ toast("Paste some lines to import"); return; }

      const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      let added = 0;

      for(const line of lines){
        // Description | Odds | optional Your%
        const parts = line.split("|").map(p=>p.trim());
        if(parts.length < 2) continue;

        const desc = parts[0];
        const amer = toNumber(parts[1]);
        if(!desc || !Number.isFinite(amer) || amer === 0) continue;

        const dec = americanToDecimal(amer);
        if(!Number.isFinite(dec)) continue;

        let userProb = NaN;
        if(parts[2] !== undefined){
          const userPct = toNumber(parts[2]);
          if(Number.isFinite(userPct)) userProb = Math.max(0.001, Math.min(0.999, userPct/100));
        }

        legs.unshift({
          sport: sportEl.value,
          market: marketEl.value,
          desc,
          american: amer,
          userProb
        });
        added++;
      }

      render();
      toast(added ? `Imported ${added} ✓` : "Nothing imported");
    }

    // ---- save/load/export
    function saveSlip(){
      const payload = {
        title: titleInput.value || "",
        oddsFormat: oddsFormat.value,
        legs,
        savedAt: new Date().toISOString()
      };
      localStorage.setItem(LS.slip, JSON.stringify(payload));
      toast("Saved ✓");
    }

    function loadSlip(){
      const raw = localStorage.getItem(LS.slip);
      if(!raw){ toast("No saved slip"); return; }
      try{
        const payload = JSON.parse(raw);
        titleInput.value = payload.title || "";
        oddsFormat.value = payload.oddsFormat || "american";
        legs = Array.isArray(payload.legs) ? payload.legs : [];
        render();
        toast("Loaded ✓");
      }catch(e){
        toast("Load failed");
      }
    }

    function exportJSON(){
      const payload = {
        title: titleInput.value || "",
        oddsFormat: oddsFormat.value,
        legs,
        exportedAt: new Date().toISOString(),
        note: "UI data only; no live odds included."
      };
      output.value = JSON.stringify(payload, null, 2);
      toast("Exported ✓");
    }

    // ---- copy (robust)
    async function copySlip(){
      const text = output.value || "";
      if(!text.trim()){ toast("Nothing to copy"); return; }

      try{
        if(navigator.clipboard && window.isSecureContext){
          await navigator.clipboard.writeText(text);
          toast("Copied ✓");
          return;
        }
      }catch{}

      // fallback
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      try{
        document.execCommand("copy");
        toast("Copied ✓");
      }catch{
        toast("Copy blocked — select manually");
      }
      document.body.removeChild(ta);
    }

    // ---- settings
    function updateCode(){
      const v = String(codeSetting.value || "").trim();
      if(!/^\d{5}$/.test(v)){ toast("Code must be 5 digits"); return; }
      setCode(v);
      defaultCodeHint.textContent = v;
      toast("Code updated ✓");
    }

    // ---- events
    unlockBtn.addEventListener("click", tryUnlock);
    codeInput.addEventListener("keydown", (e)=>{ if(e.key === "Enter") tryUnlock(); });

    addBtn.addEventListener("click", addLeg);
    [descEl, americanEl, projEl].forEach(el=>{
      el.addEventListener("keydown",(e)=>{ if(e.key === "Enter") addLeg(); });
    });

    addTemplateBtn.addEventListener("click", addTemplates);
    clearBtn.addEventListener("click", clearSlip);

    titleInput.addEventListener("input", render);
    oddsFormat.addEventListener("change", render);

    copyBtn.addEventListener("click", copySlip);
    saveBtn.addEventListener("click", saveSlip);
    loadBtn.addEventListener("click", loadSlip);
    exportBtn.addEventListener("click", exportJSON);

    setCodeBtn.addEventListener("click", updateCode);
    lockBtn.addEventListener("click", lock);

    importBtn.addEventListener("click", importLegs);
    clearImportBtn.addEventListener("click", ()=>{ importBox.value=""; toast("Import cleared"); });

    // ---- init
    function init(){
      const code = getCode();
      defaultCodeHint.textContent = code;
      codeSetting.value = code;

      // auto-load last saved slip if it exists
      const raw = localStorage.getItem(LS.slip);
      if(raw){
        try{
          const payload = JSON.parse(raw);
          titleInput.value = payload.title || "";
          oddsFormat.value = payload.oddsFormat || "american";
          legs = Array.isArray(payload.legs) ? payload.legs : [];
        }catch{}
      }

      render();

      // gate
      if(isAuthed()){
        overlay.style.display = "none";
        overlay.setAttribute("aria-hidden","true");
      } else {
        lock();
      }
    }

    init();
  </script>
</body>
</html>