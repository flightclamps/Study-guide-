<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>PROPLINE • LEAGUE SCANNER v5</title>
<style>
  :root {
    --bg: #09090b; --card: #18181b; --border: #27272a; --text: #e4e4e7;
    --muted: #a1a1aa; --accent: #3b82f6; --success: #22c55e; --danger: #ef4444; --warn: #eab308;
    --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body { margin: 0; background: var(--bg); color: var(--text); font-family: var(--font); display: flex; flex-direction: column; min-height: 100vh; }

  /* Header */
  header {
    background: rgba(9, 9, 11, 0.95); backdrop-filter: blur(8px);
    border-bottom: 1px solid var(--border); padding: 16px 20px;
    position: sticky; top: 0; z-index: 100;
    display: flex; justify-content: space-between; align-items: center;
  }
  .brand { font-weight: 800; font-size: 18px; color: #fff; letter-spacing: -0.5px; }
  .date-badge { font-size: 11px; color: var(--muted); font-family: monospace; }
  
  main { max-width: 900px; margin: 0 auto; width: 100%; padding: 16px; flex: 1; }

  /* Components */
  .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 16px; }
  .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  
  /* Buttons & Inputs */
  button {
    background: #27272a; border: 1px solid #3f3f46; color: var(--text);
    padding: 10px 16px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer;
    transition: all 0.2s;
  }
  button:hover { background: #3f3f46; }
  button.active { background: var(--accent); color: white; border-color: var(--accent); }
  button.scan-btn { flex: 1; text-align: center; }

  input {
    background: #27272a; border: 1px solid #3f3f46; color: white;
    padding: 10px; border-radius: 6px; width: 100%; outline: none;
  }

  /* Leaderboard Table */
  .table-container { overflow-x: auto; margin-top: 12px; }
  table { width: 100%; border-collapse: collapse; font-size: 13px; white-space: nowrap; }
  th { text-align: left; padding: 10px; color: var(--muted); border-bottom: 1px solid var(--border); font-size: 11px; text-transform: uppercase; }
  td { padding: 10px; border-bottom: 1px solid #27272a; }
  
  /* Status Bar */
  .progress-bar { height: 4px; background: #27272a; margin-top: 12px; border-radius: 2px; overflow: hidden; display: none; }
  .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; }

  /* Indicators */
  .score-high { color: var(--success); font-weight: 700; }
  .score-low { color: var(--danger); font-weight: 700; }
  .score-mid { color: var(--warn); }
  
  /* Detail View */
  .log-row { font-family: monospace; font-size: 12px; color: var(--muted); margin-top: 4px; display: flex; gap: 6px; }
  .hit { color: var(--success); } .miss { color: var(--danger); }

  .hidden { display: none; }
</style>
</head>
<body>

<header>
  <div class="brand">PROPLINE <span style="color:var(--accent)">SCANNER</span></div>
  <div class="date-badge">DEC 14 2025 • ACTIVE</div>
</header>

<main>
  <div class="card">
    <div style="font-size:12px; color:var(--muted); margin-bottom:8px; text-transform:uppercase; letter-spacing:1px;">Select League to Scan</div>
    <div class="row">
      <button class="scan-btn" onclick="scanner.start('nfl')">SCAN NFL (WK 15)</button>
      <button class="scan-btn" onclick="scanner.start('nba')">SCAN NBA</button>
      <button class="scan-btn" onclick="scanner.start('nhl')">SCAN NHL</button>
    </div>
    
    <div class="row" style="margin-top:12px; border-top:1px solid var(--border); padding-top:12px;">
      <input id="singleInput" placeholder="Or type single player..." style="flex:1" onkeydown="if(event.key==='Enter') scanner.single()">
      <button onclick="scanner.single()">Search One</button>
    </div>

    <div id="progressBox" class="progress-bar">
      <div id="progressFill" class="progress-fill"></div>
    </div>
    <div id="statusTxt" style="font-size:12px; color:var(--muted); margin-top:8px; min-height:16px;">System Ready.</div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <h3 style="margin:0; font-size:16px;">Live Opportunities</h3>
      <button onclick="scanner.clear()" style="padding:4px 8px; font-size:11px;">Clear</button>
    </div>
    <div class="table-container">
      <table id="resultsTable">
        <thead>
          <tr>
            <th>Player</th>
            <th>Stat</th>
            <th>Target</th>
            <th>Hit Rate</th>
            <th>Confidence</th>
            <th>Avg</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>
</main>

<script>
/* PROPLINE V5: BATCH SCANNER
  Dec 14, 2025 Context
*/

// --- PRESET TARGETS (The "Entire" League Sample) ---
const TARGETS = {
  nfl: [
    "Patrick Mahomes", "Lamar Jackson", "Josh Allen", "Christian McCaffrey", "Derrick Henry",
    "Jalen Hurts", "Saquon Barkley", "Justin Jefferson", "Tyreek Hill", "Amon-Ra St. Brown",
    "CeeDee Lamb", "Ja'Marr Chase", "Kyren Williams", "Joe Burrow", "Jahmyr Gibbs"
  ],
  nba: [
    "Nikola Jokic", "Luka Doncic", "Giannis Antetokounmpo", "Shai Gilgeous-Alexander", "Jayson Tatum",
    "Joel Embiid", "Stephen Curry", "LeBron James", "Kevin Durant", "Devin Booker",
    "Anthony Edwards", "Trae Young", "Donovan Mitchell", "Victor Wembanyama"
  ],
  nhl: [
    "Connor McDavid", "Nathan MacKinnon", "Nikita Kucherov", "Auston Matthews", "David Pastrnak",
    "Artemi Panarin", "Jack Eichel", "Mikko Rantanen", "Leon Draisaitl", "Sidney Crosby"
  ]
};

const scanner = {
  proxy: "https://api.allorigins.win/get?url=",
  activeResults: [],
  isScanning: false,

  // --- CONTROLS ---
  start: async (league) => {
    if(scanner.isScanning) return;
    scanner.isScanning = true;
    scanner.activeResults = []; // Reset
    document.getElementById('tableBody').innerHTML = "";
    document.getElementById('progressBox').style.display = 'block';
    
    const list = TARGETS[league];
    scanner.log(`Initializing ${league.toUpperCase()} scan (${list.length} players)...`);

    for(let i=0; i<list.length; i++){
      const p = list[i];
      const pct = ((i+1) / list.length) * 100;
      document.getElementById('progressFill').style.width = `${pct}%`;
      scanner.log(`Scanning [${i+1}/${list.length}]: ${p}...`);

      try {
        await scanner.processPlayer(p, league);
      } catch(e) {
        console.warn(`Skipped ${p}: ${e.message}`);
      }
      
      // Delay to respect rate limits & proxy health
      await new Promise(r => setTimeout(r, 1500));
    }

    scanner.log(`Scan Complete. Found ${scanner.activeResults.length} active lines.`);
    scanner.isScanning = false;
    setTimeout(() => { document.getElementById('progressBox').style.display = 'none'; }, 2000);
  },

  single: async () => {
    const name = document.getElementById('singleInput').value;
    if(!name) return;
    scanner.log(`Searching ${name}...`);
    try {
      // Auto-detect league hack: try NBA, if fail try NFL
      await scanner.processPlayer(name, 'nba'); 
    } catch(e) {
       try { await scanner.processPlayer(name, 'nfl'); }
       catch(e2) { try { await scanner.processPlayer(name, 'nhl'); } catch(e3) { scanner.log("Player not found."); } }
    }
  },

  clear: () => {
    document.getElementById('tableBody').innerHTML = "";
    scanner.activeResults = [];
  },

  log: (msg) => { document.getElementById('statusTxt').textContent = msg; },

  // --- CORE LOGIC ---
  processPlayer: async (name, league) => {
    // 1. Search ID
    const ts = Date.now();
    const sUrl = `https://site.web.api.espn.com/apis/common/v3/search?region=us&lang=en&short=true&limit=1&type=player&query=${encodeURIComponent(name)}&_=${ts}`;
    const sRes = await fetch(scanner.proxy + encodeURIComponent(sUrl));
    const sJson = await sRes.json();
    const data = JSON.parse(sJson.contents);
    
    if(!data.items?.length) throw new Error("No ID");
    const item = data.items[0];
    const id = item.url.match(/\/id\/(\d+)\//)[1];
    const realLeague = item.url.includes("nfl")?"nfl":item.url.includes("nhl")?"nhl":"nba";

    // 2. Fetch Logs
    const lUrl = `https://www.espn.com/${realLeague}/player/gamelog/_/id/${id}?t=${ts}`;
    const lRes = await fetch(scanner.proxy + encodeURIComponent(lUrl));
    const lJson = await lRes.json();
    
    const parser = new DOMParser();
    const doc = parser.parseFromString(lJson.contents, "text/html");
    
    // 3. Smart Parse
    const rows = Array.from(doc.querySelectorAll('.Table__TBODY tr'));
    const headerRow = doc.querySelector('.Table__THEAD tr');
    
    // Column Mapping
    const getIdx = (txts) => {
      if(!headerRow) return -1;
      const cells = Array.from(headerRow.querySelectorAll('th, td'));
      return cells.findIndex(c => txts.some(t => c.textContent.toUpperCase().includes(t)));
    };

    let valIdx = -1;
    let statLabel = "PTS";
    let line = 19.5; // Default

    if(realLeague === 'nba') { 
      valIdx = getIdx(['PTS']); 
      if(valIdx === -1) valIdx = rows[0]?.querySelectorAll('td').length - 1; 
      statLabel = "Points"; 
      line = 24.5;
    } 
    else if(realLeague === 'nhl') { 
      valIdx = getIdx(['SOG', 'SH']); 
      if(valIdx === -1) valIdx = rows[0]?.querySelectorAll('td').length - 3; 
      statLabel = "SOG"; 
      line = 3.5;
    }
    else if(realLeague === 'nfl') { 
      // Auto-detect Position preference
      const isQB = getIdx(['PASS']) > -1;
      valIdx = getIdx(['YDS']);
      statLabel = "Yards";
      line = isQB ? 245.5 : 65.5; 
    }

    // Extract Values
    const vals = [];
    const logs = [];
    rows.slice(0, 10).forEach(r => {
      const cells = r.querySelectorAll('td');
      if(cells.length < 4) return;
      if(!cells[0].textContent.match(/^[A-Za-z]{3}\s\d+\/\d+/)) return;
      
      const v = Number(cells[valIdx].textContent);
      if(!isNaN(v)) {
        vals.push(v);
        logs.push(v);
      }
    });

    if(!vals.length) return;

    // 4. Calculate Edge
    // Dynamic Line Adjustment: Set line to Average rounded
    const avg = vals.reduce((a,b)=>a+b,0)/vals.length;
    line = Math.round(avg * 2) / 2; // Round to nearest 0.5
    
    const hits = vals.filter(v => v > line).length;
    const hitRate = (hits/vals.length)*100;
    
    // Z-Score Confidence
    const sd = Math.sqrt(vals.reduce((t,v)=>t+Math.pow(v-avg,2),0)/(vals.length-1)) || 1;
    const z = (avg - line) / sd;
    let conf = 0.5 * (1 + Math.erf(z / Math.sqrt(2)));
    conf = Math.max(0, Math.min(100, conf*100));

    // Store
    scanner.activeResults.push({
      name: item.displayName,
      league: realLeague,
      stat: statLabel,
      line: line,
      hitRate: hitRate,
      conf: conf,
      avg: avg,
      logs: logs
    });

    scanner.render();
  },

  render: () => {
    // Sort by Confidence (Distance from 50%)
    scanner.activeResults.sort((a,b) => {
      const edgeA = Math.abs(a.conf - 50);
      const edgeB = Math.abs(b.conf - 50);
      return edgeB - edgeA; // Highest edge first
    });

    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = "";

    scanner.activeResults.forEach(r => {
      const isOver = r.conf > 50;
      const colorClass = r.hitRate >= 70 ? 'score-high' : r.hitRate <= 30 ? 'score-low' : 'score-mid';
      const pick = isOver ? "OVER" : "UNDER";
      
      // Mini Log Visualization
      const logViz = r.logs.slice(0,5).map(v => 
        `<span class="${v > r.line ? 'hit' : 'miss'}">${v}</span>`
      ).join(" ");

      tbody.innerHTML += `
        <tr>
          <td>
            <div style="font-weight:700">${r.name}</div>
            <div style="font-size:10px; color:var(--muted)">${r.league.toUpperCase()}</div>
          </td>
          <td>${r.stat}</td>
          <td>${r.line}</td>
          <td class="${colorClass}">${r.hitRate.toFixed(0)}%</td>
          <td>
            <div style="font-weight:bold; color:${isOver?'var(--success)':'var(--danger)'}">
              ${pick} (${r.conf.toFixed(0)}%)
            </div>
            <div class="log-row">L5: ${logViz}</div>
          </td>
          <td>${r.avg.toFixed(1)}</td>
        </tr>
      `;
    });
  }
};

// Math Polyfill
Math.erf = function(x) {
  var m = 1.0, s = 1.0, sum = x * 1.0;
  for(var i = 1; i < 50; i++){
    m *= i; s *= -1; sum += (s * Math.pow(x, 2 * i + 1)) / (m * (2 * i + 1));
  }
  return 2 * sum / Math.sqrt(Math.PI);
};
</script>
</body>
</html>
