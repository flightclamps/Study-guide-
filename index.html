<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PROP TERMINAL • HYBRID</title>
<style>
    :root {
        --bg: #050505;
        --panel: #111111;
        --border: #333333;
        --accent: #d4ff00; /* Acid Green */
        --text: #eeeeee;
        --muted: #777777;
        --danger: #ff4444;
        --success: #00cc66;
        --font: 'Courier New', Courier, monospace; /* Terminal vibe */
    }

    * { box-sizing: border-box; }

    body {
        background-color: var(--bg);
        color: var(--text);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        margin: 0;
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
    }

    /* Top Bar */
    header {
        border-bottom: 1px solid var(--border);
        padding: 15px;
        background: var(--panel);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .logo {
        font-weight: 900;
        letter-spacing: -1px;
        font-size: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .live-dot {
        height: 8px; width: 8px;
        background: var(--danger);
        border-radius: 50%;
        box-shadow: 0 0 10px var(--danger);
        animation: pulse 2s infinite;
    }

    /* Main Layout */
    .layout {
        display: flex;
        flex: 1;
        overflow: hidden;
    }

    /* Sidebar (Live Games) */
    .sidebar {
        width: 300px;
        border-right: 1px solid var(--border);
        background: #0a0a0a;
        display: flex;
        flex-direction: column;
    }
    
    .sidebar-header {
        padding: 15px;
        border-bottom: 1px solid var(--border);
        font-size: 12px;
        font-weight: 700;
        color: var(--muted);
        text-transform: uppercase;
    }

    .game-list {
        flex: 1;
        overflow-y: auto;
    }

    .game-card {
        padding: 15px;
        border-bottom: 1px solid var(--border);
        cursor: pointer;
        transition: background 0.2s;
    }
    .game-card:hover { background: #1a1a1a; }
    .game-row { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px; }
    .game-time { font-size: 11px; color: var(--accent); }
    .score { font-weight: 700; color: #fff; }

    /* Main Content */
    .workspace {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 20px;
        overflow-y: auto;
        position: relative;
    }

    /* Search Module */
    .search-box {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .input-group {
        display: flex;
        gap: 10px;
    }

    input[type="text"] {
        flex: 1;
        background: #000;
        border: 1px solid var(--border);
        color: #fff;
        padding: 15px;
        font-size: 16px;
        border-radius: 6px;
        outline: none;
    }
    input:focus { border-color: var(--accent); }

    button {
        background: var(--text);
        color: var(--bg);
        border: none;
        padding: 0 25px;
        font-weight: 700;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
    }
    button:hover { opacity: 0.9; }

    /* Analysis Panel */
    #analysisPanel { display: none; }

    .player-card {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 20px;
    }

    .stat-row {
        display: flex;
        gap: 20px;
        margin-top: 20px;
        flex-wrap: wrap;
    }

    .stat-tile {
        background: #000;
        border: 1px solid var(--border);
        padding: 15px;
        border-radius: 8px;
        min-width: 120px;
        text-align: center;
    }
    .stat-num { font-size: 24px; font-weight: 800; color: #fff; display: block; }
    .stat-label { font-size: 11px; color: var(--muted); text-transform: uppercase; margin-top: 5px; display: block; }

    /* Calculator Mode */
    .calc-mode {
        border-top: 1px dashed var(--border);
        margin-top: 20px;
        padding-top: 20px;
    }
    .manual-input {
        background: #080808;
        border: 1px solid var(--accent);
        color: var(--accent);
        font-family: var(--font);
        width: 100%;
        padding: 12px;
        margin-top: 10px;
        font-size: 14px;
    }

    /* Edge Meter */
    .meter-container {
        height: 10px;
        background: #333;
        border-radius: 5px;
        margin: 20px 0;
        position: relative;
        overflow: hidden;
    }
    .meter-bar {
        height: 100%;
        background: var(--accent);
        width: 50%;
        transition: width 0.5s ease;
    }
    .meter-center {
        position: absolute; left: 50%; top: 0; bottom: 0; width: 2px; background: #fff;
    }

    /* Mobile Hide */
    @media (max-width: 768px) {
        .sidebar { display: none; }
    }

    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
    .hidden { display: none; }
</style>
</head>
<body>

<header>
    <div class="logo">
        <div class="live-dot"></div>
        PROP TERMINAL <span style="font-size:10px; background:#333; padding:2px 6px; border-radius:4px; margin-left:10px;">v5 HYBRID</span>
    </div>
    <div style="font-size:12px; color:var(--muted)">DEC 14 2025</div>
</header>

<div class="layout">
    <div class="sidebar">
        <div class="sidebar-header">
            NFL • NBA • NHL (LIVE)
        </div>
        <div id="gamesList" class="game-list">
            <div style="padding:15px; color:#555;">Loading Scores...</div>
        </div>
    </div>

    <div class="workspace">
        
        <div class="search-box">
            <label style="display:block; margin-bottom:10px; font-size:12px; color:var(--muted);">PLAYER SEARCH OR MANUAL ENTRY</label>
            <div class="input-group">
                <input type="text" id="searchInput" placeholder="Search (e.g. Mahomes) or Team (e.g. Chiefs)..." onkeydown="if(event.key==='Enter') runSearch()">
                <button onclick="runSearch()">ANALYZE</button>
            </div>
            <div id="msgBox" style="margin-top:10px; font-size:12px; color:var(--accent);">System Ready.</div>
        </div>

        <div id="analysisPanel">
            <div class="player-card">
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <div>
                        <h1 id="pName" style="margin:0; font-size:28px;">PLAYER NAME</h1>
                        <div id="pTeam" style="color:var(--muted); font-size:14px; margin-top:5px;">TEAM • POS</div>
                    </div>
                    <div style="text-align:right;">
                        <span style="font-size:12px; color:var(--muted);">TARGET LINE</span>
                        <input type="number" id="propLine" value="20.5" style="width:70px; padding:5px; background:#000; border:1px solid #333; color:#fff; display:block; margin-top:5px;" onchange="recalc()">
                    </div>
                </div>

                <div style="margin-top:20px;">
                    <div style="display:flex; justify-content:space-between; font-size:11px; margin-bottom:5px;">
                        <span>UNDER</span>
                        <span id="probText" style="color:var(--accent); font-weight:bold;">NEUTRAL</span>
                        <span>OVER</span>
                    </div>
                    <div class="meter-container">
                        <div class="meter-center"></div>
                        <div id="meterBar" class="meter-bar"></div>
                    </div>
                </div>

                <div class="stat-row">
                    <div class="stat-tile">
                        <span class="stat-num" id="valAvg">--</span>
                        <span class="stat-label">Average (L5)</span>
                    </div>
                    <div class="stat-tile">
                        <span class="stat-num" id="valHit">--%</span>
                        <span class="stat-label">Hit Rate</span>
                    </div>
                    <div class="stat-tile">
                        <span class="stat-num" id="valTrend" style="color:var(--muted)">--</span>
                        <span class="stat-label">Trend</span>
                    </div>
                </div>

                <div class="calc-mode">
                    <div style="font-size:12px; font-weight:700; color:var(--accent); margin-bottom:8px;">
                        DATA SOURCE: <span id="sourceLabel">AUTO</span>
                    </div>
                    <p style="font-size:12px; color:var(--muted); margin:0;">
                        If auto-data is incorrect or blocked, paste recent games below to override.
                    </p>
                    <input type="text" id="manualData" class="manual-input" placeholder="e.g. 22 14 30 15 20" oninput="manualOverride()">
                </div>

            </div>
        </div>

    </div>
</div>

<script>
/* PROP TERMINAL V5
   Feature: Graceful Degradation.
   1. Live Scores (Public API)
   2. Player Search (Hidden API)
   3. Auto-Data (Scraping) -> Fallback to Manual Calc
*/

const APP = {
    proxy: "https://api.allorigins.win/get?url=",
    data: [], // Stores current numbers
    
    init: () => {
        APP.fetchScores('football/nfl'); // Default to NFL
        APP.fetchScores('basketball/nba');
        // Simple polling for live scores every 60s
        setInterval(() => APP.fetchScores('football/nfl'), 60000);
    },

    /* --- LIVE SCOREBOARD (Open API) --- */
    fetchScores: async (sportPath) => {
        // ESPN V2 Public API (Reliable)
        const url = `https://site.api.espn.com/apis/site/v2/sports/${sportPath}/scoreboard`;
        try {
            const res = await fetch(url);
            const json = await res.json();
            APP.renderScores(json.events || []);
        } catch(e) {
            console.log("Score fetch error", e);
        }
    },

    renderScores: (games) => {
        const list = document.getElementById('gamesList');
        // Clear "Loading" text on first load
        if(list.innerText.includes("Loading")) list.innerHTML = "";
        
        games.forEach(g => {
            const c = g.competitions[0];
            const home = c.competitors.find(x => x.homeAway === 'home');
            const away = c.competitors.find(x => x.homeAway === 'away');
            const status = g.status.type.shortDetail;
            
            // Avoid duplicates (simple check)
            if(document.getElementById(`g-${g.id}`)) return;

            const div = document.createElement('div');
            div.id = `g-${g.id}`;
            div.className = 'game-card';
            div.innerHTML = `
                <div class="game-row">
                    <span>${away.team.abbreviation} @ ${home.team.abbreviation}</span>
                    <span class="game-time">${status}</span>
                </div>
                <div class="game-row">
                    <span class="score">${away.score} - ${home.score}</span>
                </div>
            `;
            list.prepend(div);
        });
    },

    /* --- SEARCH ENGINE --- */
    search: async () => {
        const q = document.getElementById('searchInput').value.trim();
        if(!q) return;
        
        APP.msg("Searching database...", "normal");
        
        try {
            // 1. Search Player
            const sUrl = `https://site.web.api.espn.com/apis/common/v3/search?region=us&lang=en&short=true&limit=1&type=player&query=${encodeURIComponent(q)}`;
            const res = await fetch(APP.proxy + encodeURIComponent(sUrl));
            if(!res.ok) throw new Error("Connection failed");
            
            const json = await res.json();
            const data = JSON.parse(json.contents);
            
            if(!data.items || data.items.length === 0) {
                // If no player found, maybe it's a manual request?
                APP.msg("Player not found in DB. Enabling Manual Mode.", "err");
                APP.enableManualMode(q);
                return;
            }

            const p = data.items[0];
            const id = p.url.match(/\/id\/(\d+)\//)[1];
            
            // Detect League
            let league = 'nba';
            if(p.url.includes('nfl')) league = 'nfl';
            else if(p.url.includes('nhl')) league = 'nhl';

            APP.loadPlayerUI(p.displayName, p.subtitle || league.toUpperCase());
            
            // 2. Try Fetch Logs
            APP.msg(`Found ${p.displayName}. Fetching logs...`, "normal");
            await APP.fetchLogs(id, league);

        } catch(e) {
            APP.msg("Auto-fetch failed. Switch to manual input below.", "err");
            APP.enableManualMode(q);
        }
    },

    /* --- DATA PARSER --- */
    fetchLogs: async (id, league) => {
        // Cache buster
        const url = `https://www.espn.com/${league}/player/gamelog/_/id/${id}?t=${Date.now()}`;
        
        try {
            const res = await fetch(APP.proxy + encodeURIComponent(url));
            const json = await res.json();
            const parser = new DOMParser();
            const doc = parser.parseFromString(json.contents, "text/html");
            
            // Robust Scraping: Look for row arrays
            const rows = Array.from(doc.querySelectorAll('.Table__TBODY tr'));
            const vals = [];
            
            // Determine column index based on league defaults
            // NBA: PTS (Last), NFL: YDS (Variable), NHL: SOG (Variable)
            let colIdx = -1;
            
            // We scan the first row to find a valid number
            rows.slice(0, 10).forEach(row => {
                const cells = row.querySelectorAll('td');
                if(cells.length < 4) return;
                
                // Heuristic: Last column is usually Points/Yards
                // We try to grab the last cell with a number
                let val = 0;
                if(league === 'nba') val = Number(cells[cells.length-1].innerText); // PTS
                else if(league === 'nhl') val = Number(cells[cells.length-3].innerText); // SOG (approx)
                else if(league === 'nfl') {
                     // NFL is hard. Let's grab the biggest number in cols 3-6 (likely yards)
                     const c3 = Number(cells[3]?.innerText||0);
                     const c4 = Number(cells[4]?.innerText||0);
                     val = Math.max(c3,c4);
                }

                if(!isNaN(val)) vals.push(val);
            });

            if(vals.length === 0) throw new Error("Parse failed");
            
            APP.data = vals;
            document.getElementById('manualData').value = vals.join(" "); // Fill manual box
            document.getElementById('sourceLabel').innerText = "LIVE AUTO";
            APP.recalc();
            APP.msg("Data loaded successfully.", "success");

        } catch(e) {
            throw e; // Pass to catch block in search()
        }
    },

    /* --- LOGIC KERNEL --- */
    recalc: () => {
        const line = parseFloat(document.getElementById('propLine').value) || 0;
        const vals = APP.data;
        
        if(vals.length === 0) return;

        // Stats
        const sum = vals.reduce((a,b)=>a+b,0);
        const avg = sum / vals.length;
        const hits = vals.filter(v => v > line).length;
        const rate = (hits / vals.length) * 100;
        
        // Z-Score for Meter
        // Standard Deviation
        const sd = Math.sqrt(vals.reduce((t,v)=>t+Math.pow(v-avg,2),0)/(vals.length-1)) || 1;
        const z = (avg - line) / sd; // Positive = Over, Negative = Under
        
        // Map Z (-2 to 2) to Percentage (0% to 100%)
        let meterPct = ((z + 2) / 4) * 100;
        meterPct = Math.max(5, Math.min(95, meterPct)); // Clamp

        // Render
        document.getElementById('valAvg').innerText = avg.toFixed(1);
        document.getElementById('valHit').innerText = rate.toFixed(0) + "%";
        document.getElementById('valTrend').innerText = vals[0] > vals[vals.length-1] ? "UP" : "FLAT";
        
        const bar = document.getElementById('meterBar');
        bar.style.width = meterPct + "%";
        bar.style.background = meterPct > 60 ? "var(--success)" : meterPct < 40 ? "var(--danger)" : "var(--muted)";
        
        const txt = document.getElementById('probText');
        txt.innerText = meterPct > 60 ? "LEAN OVER" : meterPct < 40 ? "LEAN UNDER" : "NEUTRAL";
        txt.style.color = bar.style.background;
    },

    /* --- MANUAL FALLBACK --- */
    enableManualMode: (name) => {
        APP.loadPlayerUI(name || "Custom Player", "Manual Mode");
        document.getElementById('sourceLabel').innerText = "MANUAL ENTRY";
        document.getElementById('manualData').focus();
    },

    manualOverride: () => {
        const str = document.getElementById('manualData').value;
        const arr = str.trim().split(/[\s,]+/).map(Number).filter(n => !isNaN(n));
        if(arr.length > 0) {
            APP.data = arr;
            APP.recalc();
        }
    },

    loadPlayerUI: (name, team) => {
        document.getElementById('analysisPanel').style.display = 'block';
        document.getElementById('pName').innerText = name;
        document.getElementById('pTeam').innerText = team;
        APP.msg("Ready for analysis.", "normal");
    },

    msg: (txt, type) => {
        const el = document.getElementById('msgBox');
        el.innerText = "> " + txt;
        el.style.color = type === 'err' ? 'var(--danger)' : type === 'success' ? 'var(--success)' : 'var(--accent)';
    }
};

// Global Binder
window.runSearch = APP.search;
window.recalc = APP.recalc;
window.manualOverride = APP.manualOverride;

// Start
APP.init();

</script>
</body>
</html>
