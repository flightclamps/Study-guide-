<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PROPLINE • Live Advisory</title>
<style>
  :root{--bg:#0b0d10;--fg:#e7edf2;--mut:#9fb2c7;--border:#1b1f24;--card:#0f1318}
  html,body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,sans-serif}
  header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  main{max-width:980px;margin:0 auto;padding:20px}
  input,select,button,textarea{background:var(--card);color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:10px}
  button{cursor:pointer}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .card{border:1px solid var(--border);border-radius:14px;padding:14px;margin:10px 0;background:linear-gradient(180deg,#0e1217,#0b0d10)}
  .mono{font-family:ui-monospace,SFMono-Regular,Consolas,monospace}
  .mut{color:var(--mut)}
  .hide{display:none}
  .ok{color:#68f3a2}
  .err{color:#ff8080}
</style>
</head>
<body>
<header>
  <strong>PROPLINE • Live Advisory</strong>
  <span class="mut" style="font-size:12px">Advisory/education only — bet responsibly</span>
</header>

<main>
  <!-- ACCESS GATE -->
  <div id="gate" class="card">
    <div class="row">
      <b>Enter access code:</b>
      <input id="code" placeholder="64786" inputmode="numeric" pattern="[0-9]*" />
      <button onclick="unlock()">Unlock</button>
      <span id="gate_msg" class="mut"></span>
    </div>
  </div>

  <!-- APP BODY -->
  <div id="app" class="hide">
    <!-- KEYS -->
    <div class="card">
      <div class="row">
        <b>Keys (stored only in this browser tab)</b>
      </div>
      <div class="row">
        <label style="flex:1">The Odds API key
          <input id="odds_key" placeholder="paste when you want live odds" style="width:100%">
        </label>
        <label style="flex:1">OpenAI key
          <input id="openai_key" placeholder="sk-..." style="width:100%">
        </label>
        <button onclick="saveKeys()">Save</button>
        <span id="keys_status" class="mut"></span>
      </div>
      <div class="mut" style="margin-top:6px;font-size:12px">
        On GitHub Pages your keys are visible to users of this page. For private keys, run this behind a server later.
      </div>
    </div>

    <!-- CONTROLS -->
    <div class="card">
      <div class="row">
        <label>League
          <select id="league">
            <option value="nba">NBA</option>
            <option value="nfl">NFL</option>
            <option value="mlb">MLB</option>
            <option value="nhl">NHL</option>
          </select>
        </label>
        <label>Sport key (Odds API)
          <select id="sport">
            <option value="basketball_nba">basketball_nba</option>
            <option value="americanfootball_nfl">americanfootball_nfl</option>
            <option value="baseball_mlb">baseball_mlb</option>
            <option value="icehockey_nhl">icehockey_nhl</option>
          </select>
        </label>
        <button onclick="refreshAll()">Refresh now</button>
        <label><input id="autorefresh" type="checkbox" checked /> auto-refresh (60s)</label>
        <span id="stamp" class="mut"></span>
      </div>
    </div>

    <!-- SLATE -->
    <div class="card">
      <h3>Today’s Slate (live dates & times)</h3>
      <pre id="slate" class="mono">—</pre>
    </div>

    <!-- ODDS -->
    <div class="card">
      <h3>Live Odds (H2H, spreads, totals)</h3>
      <div class="mut" style="font-size:12px">Requires The Odds API key above.</div>
      <pre id="odds" class="mono">—</pre>
    </div>

    <!-- CHAT -->
    <div class="card">
      <h3>Ask anything</h3>
      <div class="mut" style="font-size:12px">Requires an OpenAI key above.</div>
      <div class="row">
        <input id="q" placeholder="e.g., draft a safe 2-leg slip for tonight" style="flex:1">
        <button onclick="ask()">Ask</button>
      </div>
      <pre id="a" class="mono">—</pre>
    </div>

    <!-- BET SLIP -->
    <div class="card">
      <h3>Draft bet slip (advisory only)</h3>
      <textarea id="picks" rows="5" class="mono" style="width:100%"
        placeholder='[{"game_id":"id","market":"spread","selection":"LAL -2.5","price":-110,"commence_time":"2025-12-14T19:05:00Z"}]'></textarea>
      <div class="row">
        <input id="stake" type="number" placeholder="Stake" value="10" style="width:120px">
        <select id="stype"><option>single</option><option>parlay</option></select>
        <button onclick="buildSlip()">Build Slip</button>
      </div>
      <pre id="slip" class="mono">—</pre>
    </div>
  </div>
</main>

<script>
  // ========= GATE =========
  const ACCESS_CODE = "64786";
  let sessionId = Math.random().toString(16).slice(2);
  const mem = []; // simple per-session memory

  function unlock() {
    const code = document.getElementById('code').value.trim();
    const msg = document.getElementById('gate_msg');
    if (code === ACCESS_CODE) {
      document.getElementById('gate').classList.add('hide');
      document.getElementById('app').classList.remove('hide');
      loadKeys();
      refreshAll();
      maybeTick();
      msg.textContent = "";
    } else {
      msg.textContent = "Wrong code.";
    }
  }

  // ========= KEYS =========
  function saveKeys() {
    const odds = document.getElementById('odds_key').value.trim();
    const openai = document.getElementById('openai_key').value.trim();
    sessionStorage.setItem('propline_odds_key', odds);
    sessionStorage.setItem('propline_openai_key', openai);
    document.getElementById('keys_status').textContent = "Saved.";
    setTimeout(()=>document.getElementById('keys_status').textContent="",1500);
  }
  function loadKeys() {
    document.getElementById('odds_key').value = sessionStorage.getItem('propline_odds_key') || "";
    document.getElementById('openai_key').value = sessionStorage.getItem('propline_openai_key') || "";
  }
  function getOddsKey(){ return sessionStorage.getItem('propline_odds_key') || ""; }
  function getOpenAIKey(){ return sessionStorage.getItem('propline_openai_key') || ""; }

  // ========= LIVE FEEDS =========
  async function fetchScoreboard(league) {
    const path = league === "nfl" ? "football/nfl" :
                 league === "mlb" ? "baseball/mlb" :
                 league === "nhl" ? "hockey/nhl" :
                 "basketball/nba";
    const url = `https://site.api.espn.com/apis/site/v2/sports/${path}/scoreboard`;
    const r = await fetch(url, { headers: { "user-agent": "propline/1.0" }});
    if (!r.ok) throw new Error("ESPN scoreboard failed: " + r.status);
    const j = await r.json();
    return (j.events||[]).map(e => {
      const c = e.competitions?.[0] || {};
      const home = c.competitors?.find(x=>x.homeAway==="home")?.team?.displayName;
      const away = c.competitors?.find(x=>x.homeAway==="away")?.team?.displayName;
      const st = (e.status?.type?.state || "pre").toLowerCase();
      return `${away} @ ${home} — ${new Date(e.date).toLocaleString()} (${st})`;
    });
  }

  async function fetchOdds(sport, region="us") {
    const key = getOddsKey();
    if (!key) throw new Error("No Odds API key");
    const url = `https://api.the-odds-api.com/v4/sports/${sport}/odds?regions=${region}&oddsFormat=american&markets=h2h,spreads,totals&apiKey=${encodeURIComponent(key)}`;
    const r = await fetch(url);
    if (!r.ok) {
      const t = await r.text().catch(()=> "");
      throw new Error(`Odds API failed: ${r.status} ${t.slice(0,120)}`);
    }
    const games = await r.json();
    return games.slice(0,10).map(g => {
      const markets = (g.bookmakers?.[0]?.markets||[]).map(m=>m.key).join(", ");
      return `• ${g.away_team} @ ${g.home_team} — ${new Date(g.commence_time).toLocaleString()}
  markets: ${markets}`;
    });
  }

  // ========= CHAT =========
  async function ask() {
    const openaiKey = getOpenAIKey();
    const msg = document.getElementById('q').value.trim();
    if (!openaiKey) { document.getElementById('a').textContent = "Add your OpenAI key first."; return; }
    if (!msg) return;

    mem.push({ role:"user", text: msg, t: Date.now() });
    const league = document.getElementById('league').value;
    const sport  = document.getElementById('sport').value;

    // pull fresh data to ground the answer
    let slateTxt = "[]", oddsTxt = "[]";
    try { slateTxt = JSON.stringify(await fetchScoreboard(league)); } catch {}
    try { oddsTxt  = JSON.stringify(await fetchOdds(sport)); } catch {}

    const system = `
You are a cautious sports advisory assistant.
- Use only the provided live data payloads.
- Always show exact game times & dates from the payload.
- Never guarantee outcomes. Keep it concise.
- For parlays/slips, include kickoff timestamps and a brief responsible note.`;

    const tools = [
      JSON.stringify({ memory: mem.slice(-8) }),
      JSON.stringify({ slate: slateTxt }),
      JSON.stringify({ odds: oddsTxt }),
    ];

    try {
      const r = await fetch("https://api.openai.com/v1/responses", {
        method: "POST",
        headers: { "content-type":"application/json", "authorization": "Bearer " + openaiKey },
        body: JSON.stringify({
          model: "gpt-4o", // change if your account uses a different model
          input: [
            { role:"system", content: system },
            { role:"tool", content: tools[0] },
            { role:"tool", content: tools[1] },
            { role:"tool", content: tools[2] },
            { role:"user", content: msg }
          ]
        })
      });
      if (!r.ok) throw new Error("OpenAI error: " + r.status);
      const data = await r.json();
      const out = data.output_text || "(no response)";
      mem.push({ role:"assistant", text: out, t: Date.now() });
      document.getElementById('a').textContent = out;
    } catch (e) {
      document.getElementById('a').textContent = "Chat error: " + e.message;
    }
  }

  // ========= BET SLIP =========
  function buildSlip() {
    const picks = JSON.parse(document.getElementById('picks').value || "[]");
    const stake = Number(document.getElementById('stake').value || "0");
    const type  = document.getElementById('stype').value;
    const legs = picks.map((p,i)=>({
      id:`leg_${i+1}`, game_id:p.game_id, market:p.market, selection:p.selection,
      price:p.price, kickoff:p.commence_time
    }));
    const slip = { createdAt:new Date().toISOString(), sessionId, type, stake, legs };
    document.getElementById('slip').textContent = JSON.stringify(slip,null,2);
  }

  // ========= UI FLOW =========
  async function refreshAll() {
    const league = document.getElementById('league').value;
    const sport  = document.getElementById('sport').value;
    document.getElementById('stamp').textContent = "Refreshing…";
    // Slate
    try {
      const lines = await fetchScoreboard(league);
      document.getElementById('slate').textContent = lines.join("\n") || "No events";
    } catch (e) {
      document.getElementById('slate').textContent = "Error: " + e.message;
    }
    // Odds
    try {
      const lines = await fetchOdds(sport);
      document.getElementById('odds').textContent = lines.join("\n\n") || "No odds";
    } catch (e) {
      document.getElementById('odds').textContent = "Odds: " + e.message + " (paste The Odds API key above)";
    }
    document.getElementById('stamp').textContent = "Last updated: " + new Date().toLocaleString();
  }

  function maybeTick() {
    const cb = document.getElementById('autorefresh');
    if (!cb) return;
    setInterval(()=>{ if (cb.checked) refreshAll(); }, 60_000);
  }
</script>
</body>
</html>